<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>RSS Morning Briefing</title>
    <style>
      body { font-family: Arial, sans-serif; background-color: #f5f5f5; color: #1a1a1a; margin: 0; padding: 24px; }
      .container { max-width: 720px; margin: 0 auto; background-color: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 24px rgba(0,0,0,0.08); }
      header { background-color: #1f2937; color: #ffffff; padding: 24px; }
      header h1 { margin: 0; font-size: 24px; }
      .content { padding: 24px; }
      .card { border-bottom: 1px solid #e5e7eb; padding: 16px 0; }
      .card:last-child { border-bottom: none; }
      .badge { display: inline-block; background-color: #2563eb; color: #ffffff; padding: 4px 8px; border-radius: 999px; font-size: 12px; margin-bottom: 12px; }
      h2 { font-size: 20px; margin: 0 0 12px 0; }
      p { margin: 8px 0; line-height: 1.6; }
      a { color: #2563eb; text-decoration: none; }
      footer { padding: 16px 24px; font-size: 12px; color: #6b7280; background-color: #f3f4f6; }
      .section-label { font-weight: bold; color: #374151; text-transform: uppercase; font-size: 12px; letter-spacing: 0.08em; margin-bottom: 6px; }
      .media { margin: 16px 0; border-radius: 12px; overflow: hidden; box-shadow: 0 12px 24px rgba(15,23,42,0.15); display: flex; justify-content: center; }
      .media img { width: auto; max-width: 100%; height: auto; max-height: 400px; display: block; border: 0; }
      .media-caption { font-size: 12px; color: #6b7280; text-align: right; margin-top: 6px; }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>RSS Morning Briefing</h1>
      </header>
      <div class="content">
        {% if fallback %}
          <pre>{{ fallback }}</pre>
        {% elif is_summary %}
          {% set summaries = payload.get("summaries") or [] %}
          {% if summaries %}
            {% for item in summaries %}
              <div class="card">
                <div class="badge">{{ item.get("topic") or item.get("category") or "Topic" }}</div>
                <h2>{{ item.get("summary", {}).get("title") or "Briefing" }}</h2>
                
                {% if item.get("valid_count") %}
                   <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
                     Analyzing {{ item.get("valid_count") }} relevant items
                   </p>
                {% endif %}

                {% if item.get("key_threats") %}
                   <div class="section-label">Key Threats & Observations</div>
                   <ul style="padding-left: 20px; margin-top: 8px;">
                     {% for threat in item.get("key_threats") %}
                       <li>{{ threat | replace("- ", "") }}</li>
                     {% endfor %}
                   </ul>
                {% elif item.get("summary", {}).get("what") %}
                   {# Fallback for old format or if mapped #}
                   <div class="section-label">Summary</div>
                   <p>{{ item.get("summary", {}).get("what") | nl2br }}</p>
                {% endif %}

                {# List source articles if available #}
                {% set articles = item.get("articles") or [] %}
                {% if articles %}
                  <div style="margin-top: 16px; border-top: 1px solid #eee; padding-top: 12px;">
                    <div class="section-label" style="margin-bottom: 8px;">Sources</div>
                    <ul style="list-style: none; padding: 0; margin: 0; font-size: 13px;">
                      {% for art in articles %}
                        <li style="margin-bottom: 6px;">
                          <a href="{{ art.get("url") }}" target="_blank" rel="noopener">{{ art.get("title") or "Source Article" }}</a>
                        </li>
                      {% endfor %}
                    </ul>
                  </div>
                {% endif %}

              </div>
            {% endfor %}
          {% else %}
            <p>No relevant articles identified.</p>
          {% endif %}
        {% else %}
          {% set articles = payload %}
          {% if articles %}
            {% for article in articles %}
              <div class="card">
                {% if article.get("category") %}
                  <div class="badge">{{ article.get("category") }}</div>
                {% endif %}
                <h2>{{ article.get("title") or article.get("url") or "Untitled Article" }}</h2>
                {% if article.get("image") %}
                  <div class="media">
                    <img src="{{ article.get("image") }}" alt="{{ article.get("title") or "Article image" }}" />
                  </div>
                  {% if article.get("url") %}
                    <div class="media-caption">Image from <a href="{{ article.get("url") }}" target="_blank" rel="noopener">source article</a></div>
                  {% endif %}
                {% endif %}
                <div class="section-label">Summary</div>
                <p>{{ article.get("summary") | nl2br or "â€”" }}</p>
                {% if article.get("text") %}
                  <div class="section-label">Excerpt</div>
                  <p>{{ article.get("text") | nl2br }}</p>
                {% endif %}
                {% if article.get("url") %}
                  <p><a href="{{ article.get("url") }}" target="_blank" rel="noopener">Read Full Article</a></p>
                {% endif %}
              </div>
            {% endfor %}
          {% else %}
            <p>No articles retrieved.</p>
          {% endif %}
        {% endif %}
      </div>
      <footer>
        Generated automatically by rss-morning.
      </footer>
    </div>
  </body>
</html>

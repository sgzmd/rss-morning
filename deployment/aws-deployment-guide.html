<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>RSS-Morning AWS Deployment Guide</title>
  <style>

code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}

ul.task-list[class]{list-style: none;}
ul.task-list li input[type="checkbox"] {
font-size: inherit;
width: 0.8em;
margin: 0 0.8em 0.2em -1.6em;
vertical-align: middle;
}
.display.math{display: block; text-align: center; margin: 0.5rem auto;}

html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
  <style type="text/css">:root {
--bg-color: #f8f9fa;
--text-color: #24292e;
--sidebar-width: 300px;
--content-max-width: 900px;
--accent-color: #0366d6;
--code-bg: #f6f8fa;
--border-color: #e1e4e8;
}
body {
font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
line-height: 1.6;
color: var(--text-color);
background-color: #fff;
margin: 0;
margin-left: 320px;

padding: 2rem 4rem;
max-width: 900px;

display: block;
}

.main-container {
display: flex;
width: 100%;
max-width: 1400px;
background: white;
min-height: 100vh;
box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
}

nav#TOC {
width: var(--sidebar-width);
position: fixed;
left: 0;
top: 0;
height: 100vh;
overflow-y: auto;
padding: 2rem;
background-color: #fcfcfc;
border-right: 1px solid var(--border-color);
box-sizing: border-box;
font-size: 0.9rem;
}
nav#TOC ul {
list-style: none;
padding-left: 0;
}
nav#TOC ul ul {
padding-left: 1.5em;
margin-top: 0.5em;
}
nav#TOC a {
text-decoration: none;
color: #586069;
display: block;
padding: 4px 0;
transition: color 0.2s;
}
nav#TOC a:hover {
color: var(--accent-color);
}

h1,
h2,
h3 {
margin-top: 2rem;
margin-bottom: 1rem;
font-weight: 600;
line-height: 1.25;
}
h1 {
font-size: 2.5rem;
border-bottom: 1px solid var(--border-color);
padding-bottom: 0.5rem;
}
h2 {
font-size: 1.75rem;
border-bottom: 1px solid var(--border-color);
padding-bottom: 0.3rem;
}
h3 {
font-size: 1.25rem;
}
a {
color: var(--accent-color);
text-decoration: none;
}
a:hover {
text-decoration: underline;
}

pre {
background-color: var(--code-bg);
border-radius: 6px;
padding: 16px;
overflow: auto;
font-size: 90%;
border: 1px solid var(--border-color);
}
code {
font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
padding: 0.2em 0.4em;
margin: 0;
font-size: 85%;
background-color: rgba(27, 31, 35, 0.05);
border-radius: 3px;
}
pre>code {
background-color: transparent;
padding: 0;
font-size: 100%;
}
blockquote {
color: #6a737d;
border-left: 0.25em solid #dfe2e5;
padding: 0 1em;
margin-left: 0;
}

@media (max-width: 1000px) {
body {
margin-left: 0;
padding: 2rem;
}
nav#TOC {
position: static;
width: 100%;
height: auto;
border-right: none;
border-bottom: 1px solid #eee;
margin-bottom: 2rem;
}
}</style>
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    
    mermaid.initialize({ startOnLoad: false, theme: 'default' });

    document.addEventListener('DOMContentLoaded', async () => {
      // Select the pre.mermaid elements that Pandoc generates
      const pandocBlocks = document.querySelectorAll('pre.mermaid');
      
      for (const block of pandocBlocks) {
        // Decode HTML entities (like --&gt;) by reading textContent
        const rawMermaid = block.textContent;
        
        // Create a replacement div
          const div = document.createElement('div');
          div.className = 'mermaid';
          div.textContent = rawMermaid;
          
          // Replace <pre><code>...</code></pre> with <div class="mermaid">...</div>
          block.parentNode.replaceChild(div, block);
      }
      
      // Now trigger mermaid to render the clean divs
      await mermaid.run({
        nodes: document.querySelectorAll('div.mermaid')
      });
    });
  </script>
</head>
<body>
<header id="title-block-header">
<h1 class="title">RSS-Morning AWS Deployment Guide</h1>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#part-0-architecture-overview" id="toc-part-0-architecture-overview">Part 0: Architecture Overview</a>
<ul>
<li><a href="#goal" id="toc-goal">Goal</a></li>
<li><a href="#the-serverless-lambda-pattern" id="toc-the-serverless-lambda-pattern">The “Serverless (Lambda)”
Pattern</a></li>
<li><a href="#architecture-diagram" id="toc-architecture-diagram">Architecture Diagram</a></li>
<li><a href="#key-components" id="toc-key-components">Key
Components</a></li>
<li><a href="#trade-off-analysis-lambda-vs.-fargate" id="toc-trade-off-analysis-lambda-vs.-fargate">Trade-off Analysis:
Lambda vs. Fargate</a></li>
</ul></li>
<li><a href="#part-1-security-principles" id="toc-part-1-security-principles">Part 1: Security Principles</a>
<ul>
<li><a href="#least-privilege-iam" id="toc-least-privilege-iam">1. Least
Privilege (IAM)</a></li>
<li><a href="#secrets-management" id="toc-secrets-management">2. Secrets
Management</a></li>
<li><a href="#networking-vpc" id="toc-networking-vpc">3. Networking
&amp; VPC</a></li>
<li><a href="#container-security" id="toc-container-security">4.
Container Security</a></li>
</ul></li>
<li><a href="#part-2-prerequisites" id="toc-part-2-prerequisites">Part
2: Prerequisites</a>
<ul>
<li><a href="#aws-cli-v2" id="toc-aws-cli-v2">1. AWS CLI v2</a></li>
<li><a href="#docker" id="toc-docker">2. Docker</a></li>
<li><a href="#aws-cdk-cloud-development-kit---python" id="toc-aws-cdk-cloud-development-kit---python">3. AWS CDK (Cloud
Development Kit) - Python</a></li>
<li><a href="#accounts" id="toc-accounts">4. Accounts</a></li>
</ul></li>
<li><a href="#part-3-application-preparation" id="toc-part-3-application-preparation">Part 3: Application
Preparation</a>
<ul>
<li><a href="#dockerfile-optimization" id="toc-dockerfile-optimization">1. Dockerfile Optimization</a>
<ul>
<li><a href="#using-aws-lambda-base-images-recommended" id="toc-using-aws-lambda-base-images-recommended">Using AWS Lambda Base
Images (Recommended)</a></li>
<li><a href="#using-custom-base-images-your-current-setup" id="toc-using-custom-base-images-your-current-setup">Using Custom Base
Images (Your current setup)</a></li>
</ul></li>
<li><a href="#create-a-lambda-adapter" id="toc-create-a-lambda-adapter">2. Create a Lambda Adapter</a></li>
<li><a href="#configuration-secrets" id="toc-configuration-secrets">3.
Configuration &amp; Secrets</a></li>
<li><a href="#dockerignore" id="toc-dockerignore">4.
.dockerignore</a></li>
</ul></li>
<li><a href="#part-4-networking-id" id="toc-part-4-networking-id">Part
4: Networking &amp; ID</a>
<ul>
<li><a href="#networking-strategy" id="toc-networking-strategy">1.
Networking Strategy</a>
<ul>
<li><a href="#option-a-public-networking-recommended" id="toc-option-a-public-networking-recommended">Option A: Public
Networking (Recommended)</a></li>
<li><a href="#option-b-vpc-networking" id="toc-option-b-vpc-networking">Option B: VPC Networking</a></li>
</ul></li>
<li><a href="#iam-roles-identity" id="toc-iam-roles-identity">2. IAM
Roles (Identity)</a>
<ul>
<li><a href="#lambda-execution-role" id="toc-lambda-execution-role">Lambda Execution Role</a></li>
</ul></li>
</ul></li>
<li><a href="#part-5-infrastructure-as-code-cdk" id="toc-part-5-infrastructure-as-code-cdk">Part 5: Infrastructure as
Code (CDK)</a>
<ul>
<li><a href="#setup" id="toc-setup">1. Setup</a></li>
<li><a href="#the-stack-infrastructureinfrastructure_stack.py" id="toc-the-stack-infrastructureinfrastructure_stack.py">2. The Stack
(<code>infrastructure/infrastructure_stack.py</code>)</a></li>
<li><a href="#deploy" id="toc-deploy">3. Deploy</a></li>
</ul></li>
<li><a href="#part-6-pipeline-deployment" id="toc-part-6-pipeline-deployment">Part 6: Pipeline &amp;
Deployment</a>
<ul>
<li><a href="#build-and-push" id="toc-build-and-push">1. Build and
Push</a></li>
<li><a href="#register-task-definition" id="toc-register-task-definition">2. Register Task Definition</a></li>
</ul></li>
<li><a href="#part-7-scheduling" id="toc-part-7-scheduling">Part 7:
Scheduling</a>
<ul>
<li><a href="#overview" id="toc-overview">Overview</a></li>
<li><a href="#cron-syntax" id="toc-cron-syntax">Cron Syntax</a></li>
<li><a href="#cdk-implementation" id="toc-cdk-implementation">CDK
Implementation</a></li>
<li><a href="#manual-setup-console" id="toc-manual-setup-console">Manual
Setup (Console)</a></li>
</ul></li>
</ul>
</nav>
<h1 id="part-0-architecture-overview">Part 0: Architecture Overview</h1>
<h2 id="goal">Goal</h2>
<p>Deploy <code>rss-morning</code> as a secure, automated, serverless
batch job on AWS using <strong>AWS Lambda</strong>.</p>
<h2 id="the-serverless-lambda-pattern">The “Serverless (Lambda)”
Pattern</h2>
<p>We are using <strong>AWS Lambda</strong> with <strong>Container Image
Support</strong>.</p>
<ul>
<li><strong>Why?</strong>
<ul>
<li><strong>Cost</strong>: extremely low for sporadic jobs (pay per
millisecond).</li>
<li><strong>Simplicity</strong>: No cluster management.</li>
<li><strong>Scalability</strong>: Scales to zero automatically.</li>
</ul></li>
<li><strong>Container Support</strong>: Allows us to package our complex
dependencies (Pandas, Numpy, NLTK) in a familiar Docker environment,
bypassing the standard 250MB size limit of Lambda zip archives (supports
up to 10GB images).</li>
</ul>
<h2 id="architecture-diagram">Architecture Diagram</h2>
<pre class="mermaid"><code>flowchart LR
    Scheduler[EventBridge Scheduler]
    
    subgraph Region
        Lambda[AWS Lambda Function\n(Container Image)]
    end
    
    ECR[Amazon ECR]
    SSM[Systems Manager / Secrets Manager]
    Internet((Internet))
    CW[CloudWatch Logs]

    Scheduler --&gt;|Triggers cron| Lambda
    Lambda --&gt;|Pulls Image| ECR
    Lambda --&gt;|Reads Secrets| SSM
    Lambda --&gt;|Fetches Feeds| Internet
    Lambda --&gt;|Logs| CW</code></pre>
<h2 id="key-components">Key Components</h2>
<ol type="1">
<li><strong>Docker Container</strong>: The unit of deployment.</li>
<li><strong>Amazon ECR</strong>: Hosting the Docker container
image.</li>
<li><strong>AWS Lambda</strong>: The compute service running the
container.</li>
<li><strong>EventBridge Scheduler</strong>: Triggers the function every
morning.</li>
<li><strong>IAM</strong>: Least-privilege roles for the function.</li>
</ol>
<h2 id="trade-off-analysis-lambda-vs.-fargate">Trade-off Analysis:
Lambda vs. Fargate</h2>
<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Feature</th>
<th style="text-align: left;">AWS Lambda (Container)</th>
<th style="text-align: left;">AWS Fargate (ECS)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Cost</strong></td>
<td style="text-align: left;"><strong>Cheapest</strong> for short,
sporadic jobs (&lt; 15 mins). Pay per ms.</td>
<td style="text-align: left;">Higher minimum cost. Pay for provisioned
CPU/RAM per second (min 1 min).</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Duration Limit</strong></td>
<td style="text-align: left;"><strong>Strict 15-minute
timeout</strong>.</td>
<td style="text-align: left;">Unlimited duration.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Startup (Cold Start)</strong></td>
<td style="text-align: left;">Can be slow (seconds) for large container
images, but negligible for batch jobs.</td>
<td style="text-align: left;">Slower startup (minutes) to provision
task.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Compute Power</strong></td>
<td style="text-align: left;">Up to 10GB RAM / 6 vCPU.</td>
<td style="text-align: left;">Customizable vCPU/RAM combos (up to 16
vCPU / 120GB).</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Networking</strong></td>
<td style="text-align: left;">Can run in VPC (slower cold start, needs
NAT Gateway for internet) or Public (fast, cheap).</td>
<td style="text-align: left;">Running in Public Subnet allows direct
internet access without NAT Gateway.</td>
</tr>
</tbody>
</table>
<p><strong>Recommendation</strong>: Since the <code>rss-morning</code>
job typically completes in under 15 minutes, <strong>AWS Lambda</strong>
is the most cost-effective and simple solution. If the job grows to
exceed 15 minutes, we can easily migrate the same Docker image to
Fargate.</p>
<h1 id="part-1-security-principles">Part 1: Security Principles</h1>
<h2 id="least-privilege-iam">1. Least Privilege (IAM)</h2>
<ul>
<li><strong>Service Role</strong>: The Lambda function must have a
devoted IAM Role.</li>
<li><strong>Policies</strong>:
<ul>
<li><code>logs:CreateLogGroup</code>, <code>logs:CreateLogStream</code>,
<code>logs:PutLogEvents</code> (CloudWatch).</li>
<li><code>secretsmanager:GetSecretValue</code> (for accessing API keys)
OR <code>ssm:GetParameter</code>.</li>
<li><strong>NO</strong> broad <code>*</code> permissions.</li>
</ul></li>
</ul>
<h2 id="secrets-management">2. Secrets Management</h2>
<ul>
<li><strong>Do NOT</strong> embed API keys in <code>Dockerfile</code> or
source code.</li>
<li><strong>Do NOT</strong> use plain-text Environment Variables in the
Lambda configuration for sensitive data (they are visible in the
console).</li>
<li><strong>Best Practice</strong>:
<ul>
<li>Store <code>OPENAI_API_KEY</code> and <code>RESEND_API_KEY</code> in
<strong>AWS Secrets Manager</strong> or <strong>SSM Parameter Store
(SecureString)</strong>.</li>
<li>Inject them at runtime:
<ul>
<li><strong>Option A</strong>: Use the AWS Parameters and Secrets Lambda
Extension (caches secrets, easy access).</li>
<li><strong>Option B</strong>: Use the AWS SDK (<code>boto3</code>)
inside the app to fetch them on startup.</li>
</ul></li>
</ul></li>
</ul>
<h2 id="networking-vpc">3. Networking &amp; VPC</h2>
<ul>
<li><strong>Default (Recommended for this use case)</strong>: Run Lambda
<strong>outside of VPC</strong>.
<ul>
<li><strong>Pros</strong>: Fastest cold starts, free direct internet
access (required for RSS feeds).</li>
<li><strong>Cons</strong>: Cannot access internal private resources
(RDS, Redis) - <em>Not applicable here</em>.</li>
</ul></li>
<li><strong>VPC Deployment</strong>: If you <em>must</em> run in a VPC:
<ul>
<li>Place Lambda in <strong>Private Subnets</strong>.</li>
<li>You <strong>MUST</strong> provision a <strong>NAT Gateway</strong>
in a Public Subnet to access public internet (RSS feeds, External
APIs).</li>
<li><strong>Warning</strong>: NAT Gateways cost ~$30/month + data
processing fees. Avoid unless necessary.</li>
</ul></li>
</ul>
<h2 id="container-security">4. Container Security</h2>
<ul>
<li><strong>ReadOnly Root Filesystem</strong>: Configure the application
to write temporary files only to <code>/tmp</code> (Lambda provides
512MB-10GB ephemeral storage at <code>/tmp</code>).</li>
<li><strong>Non-Root User</strong>: Ideally, run the container as a
non-root user (though Lambda maps the user automatically, it’s good
practice in Dockerfile).</li>
</ul>
<h1 id="part-2-prerequisites">Part 2: Prerequisites</h1>
<p>Before deploying, ensure you have the following installed and
configured:</p>
<h2 id="aws-cli-v2">1. AWS CLI v2</h2>
<ul>
<li><strong>Install</strong>: <a href="https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html">Official
AWS CLI Install Guide</a></li>
<li><strong>Verify</strong>: <code>aws --version</code></li>
<li><strong>Configure</strong>: Run <code>aws configure</code> to set up
your credentials and default region.</li>
</ul>
<h2 id="docker">2. Docker</h2>
<ul>
<li><strong>Install</strong>: Docker Desktop or Docker Engine.</li>
<li><strong>Verify</strong>: <code>docker --version</code></li>
<li><strong>Purpose</strong>: Used to build the container image locally
before pushing to ECR.</li>
</ul>
<h2 id="aws-cdk-cloud-development-kit---python">3. AWS CDK (Cloud
Development Kit) - Python</h2>
<p>We will use AWS CDK to define our infrastructure as code. *
<strong>Install Node.js</strong> (Required for CDK CLI):
<code>npm install -g aws-cdk</code> * <strong>Verify</strong>:
<code>cdk --version</code> * <strong>Python Dependencies</strong>: You
will need to install python CDK libraries in your project (listed in
infrastructure section).</p>
<h2 id="accounts">4. Accounts</h2>
<ul>
<li><strong>AWS Account</strong>: With permission to create IAM Roles,
Lambda Functions, ECR Repos, and EventBridge Schedules.</li>
<li><strong>External API Keys</strong>: OpenAI and Resend API keys ready
to be put into Secrets Manager.</li>
</ul>
<h1 id="part-3-application-preparation">Part 3: Application
Preparation</h1>
<h2 id="dockerfile-optimization">1. Dockerfile Optimization</h2>
<p>To run on AWS Lambda via Container Images, your
<code>Dockerfile</code> needs to be compatible with Lambda’s execution
environment.</p>
<h3 id="using-aws-lambda-base-images-recommended">Using AWS Lambda Base
Images (Recommended)</h3>
<p>The easiest way is to use AWS provided base images.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> public.ecr.aws/lambda/python:3.11</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Copy requirements.txt</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> requirements.txt ${LAMBDA_TASK_ROOT}</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Install the specified packages</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">pip</span> install <span class="at">-r</span> requirements.txt</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Copy function code</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> . ${LAMBDA_TASK_ROOT}</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the CMD to your handler (could be a specific lambda_handler function)</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="kw">CMD</span> [ <span class="st">&quot;main.lambda_handler&quot;</span> ] </span></code></pre></div>
<h3 id="using-custom-base-images-your-current-setup">Using Custom Base
Images (Your current setup)</h3>
<p>If you stick with your standard <code>python:3.11-slim</code> image,
you must install the <strong>AWS Lambda Runtime Interface Client
(RIC)</strong>.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ... existing setup ...</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">pip</span> install awslambdaric</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Set entrypoint to the RIC</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="kw">ENTRYPOINT</span> [ <span class="st">&quot;python&quot;</span>, <span class="st">&quot;-m&quot;</span>, <span class="st">&quot;awslambdaric&quot;</span> ]</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="kw">CMD</span> [ <span class="st">&quot;main.lambda_handler&quot;</span> ]</span></code></pre></div>
<p><strong>Recommendation</strong>: Since <code>rss-morning</code> is a
CLI tool, you will need a small adapter (wrapper) to make it invokable
by Lambda.</p>
<h2 id="create-a-lambda-adapter">2. Create a Lambda Adapter</h2>
<p>Create a small file <code>lambda_main.py</code> (or add to
<code>main.py</code>) to bridge the Lambda event to your CLI logic.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># main.py addition specifically for Lambda</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rss_morning.cli <span class="im">import</span> main</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> lambda_handler(event, context):</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">    AWS Lambda entrypoint.</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Bridge the execution to the CLI main function.</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Starting RSS Morning job via Lambda...&quot;</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Optional: Override args based on event payload if needed</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># sys.argv = [&quot;rss-morning&quot;, &quot;--env&quot;, &quot;prod&quot;]</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Run the main CLI logic</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Note: You might need to adjust &#39;main()&#39; to not sys.exit() </span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># but just return configuration/status</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        main() </span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">&quot;statusCode&quot;</span>: <span class="dv">200</span>, <span class="st">&quot;body&quot;</span>: <span class="st">&quot;Success&quot;</span>}</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;Job failed: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">&quot;statusCode&quot;</span>: <span class="dv">500</span>, <span class="st">&quot;body&quot;</span>: <span class="bu">str</span>(e)}</span></code></pre></div>
<h2 id="configuration-secrets">3. Configuration &amp; Secrets</h2>
<ul>
<li><strong>Configs</strong>: Ensure <code>config.prod.xml</code> is
copied into the image at build time (e.g.,
<code>COPY configs/config.prod.xml ${LAMBDA_TASK_ROOT}/configs/config.xml</code>).</li>
<li><strong>Secrets</strong>: Do <strong>not</strong> bake secrets into
the image.
<ul>
<li>The code should attempt to read <code>OPENAI_API_KEY</code> from
environment variables, which will be populated by the Lambda
configuration (which in turn can rely on Secrets Manager or secure env
vars).</li>
</ul></li>
</ul>
<h2 id="dockerignore">4. .dockerignore</h2>
<p>Ensure you have a <code>.dockerignore</code> to keep the image small
and secure:</p>
<pre class="text"><code>.git
.env
venv
tests
__pycache__
my_local_config.xml</code></pre>
<h1 id="part-4-networking-id">Part 4: Networking &amp; ID</h1>
<h2 id="networking-strategy">1. Networking Strategy</h2>
<h3 id="option-a-public-networking-recommended">Option A: Public
Networking (Recommended)</h3>
<ul>
<li><strong>Configuration</strong>: Configure the Lambda function with
<strong>No VPC</strong>.</li>
<li><strong>Behavior</strong>: The Lambda functions runs in AWS’s public
secure zone. It has direct access to the public internet.</li>
<li><strong>Cost</strong>: $0 extra.</li>
<li><strong>Use Case</strong>: Perfect for <code>rss-morning</code>
which only needs to access public RSS feeds, OpenAI API, and Resend
API.</li>
</ul>
<h3 id="option-b-vpc-networking">Option B: VPC Networking</h3>
<ul>
<li><strong>Configuration</strong>: Connect Lambda to a VPC Private
Subnet.</li>
<li><strong>Requirement</strong>: You <strong>MUST</strong> deploy a
<strong>NAT Gateway</strong> in a Public Subnet and route traffic
through it.</li>
<li><strong>Cost</strong>: ~$30/month minimum for NAT Gateway.</li>
<li><strong>Use Case</strong>: Only required if you need to connect to a
private RDS database or ElastiCache.</li>
</ul>
<p><strong>Decision</strong>: Go with <strong>Option A</strong> (No
VPC).</p>
<h2 id="iam-roles-identity">2. IAM Roles (Identity)</h2>
<h3 id="lambda-execution-role">Lambda Execution Role</h3>
<p>This role assumes <code>lambda.amazonaws.com</code> service principal
and needs the following permissions:</p>
<p><strong>1. Basic Execution (Logs)</strong> Managed Policy:
<code>AWSLambdaBasicExecutionRole</code> *
<code>logs:CreateLogGroup</code> * <code>logs:CreateLogStream</code> *
<code>logs:PutLogEvents</code></p>
<p><strong>2. Secrets Access (If using Secrets Manager)</strong> Inline
Policy:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;Version&quot;</span><span class="fu">:</span> <span class="st">&quot;2012-10-17&quot;</span><span class="fu">,</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;Statement&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;Effect&quot;</span><span class="fu">:</span> <span class="st">&quot;Allow&quot;</span><span class="fu">,</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;Action&quot;</span><span class="fu">:</span> <span class="st">&quot;secretsmanager:GetSecretValue&quot;</span><span class="fu">,</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;Resource&quot;</span><span class="fu">:</span> <span class="st">&quot;arn:aws:secretsmanager:REGION:ACCOUNT:secret:rss-morning/*&quot;</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="ot">]</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><strong>3. SSM Parameter Access (If using Parameter Store)</strong>
Inline Policy:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;Version&quot;</span><span class="fu">:</span> <span class="st">&quot;2012-10-17&quot;</span><span class="fu">,</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;Statement&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;Effect&quot;</span><span class="fu">:</span> <span class="st">&quot;Allow&quot;</span><span class="fu">,</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;Action&quot;</span><span class="fu">:</span> <span class="st">&quot;ssm:GetParameter&quot;</span><span class="fu">,</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;Resource&quot;</span><span class="fu">:</span> <span class="st">&quot;arn:aws:ssm:REGION:ACCOUNT:parameter/rss-morning/*&quot;</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="ot">]</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h1 id="part-5-infrastructure-as-code-cdk">Part 5: Infrastructure as
Code (CDK)</h1>
<p>We will use <strong>AWS CDK (Python)</strong> to define the
stack.</p>
<h2 id="setup">1. Setup</h2>
<p>Initialize a new CDK app (in a separate folder, e.g.,
<code>infrastructure/</code>):</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> infrastructure <span class="kw">&amp;&amp;</span> <span class="bu">cd</span> infrastructure</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ex">cdk</span> init app <span class="at">--language</span> python</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> .venv/bin/activate</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install aws-cdk-lib constructs</span></code></pre></div>
<h2 id="the-stack-infrastructureinfrastructure_stack.py">2. The Stack
(<code>infrastructure/infrastructure_stack.py</code>)</h2>
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> aws_cdk <span class="im">import</span> (</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    Stack,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    Duration,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    aws_lambda <span class="im">as</span> _lambda,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    aws_ecr <span class="im">as</span> ecr,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    aws_events <span class="im">as</span> events,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    aws_events_targets <span class="im">as</span> targets,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    aws_secretsmanager <span class="im">as</span> secretsmanager,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    aws_ssm <span class="im">as</span> ssm,</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> constructs <span class="im">import</span> Construct</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RssMorningStack(Stack):</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, scope: Construct, construct_id: <span class="bu">str</span>, <span class="op">**</span>kwargs) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(scope, construct_id, <span class="op">**</span>kwargs)</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 1. ECR Repository (External or Created here)</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If you already pushed the image manually:</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>        repo <span class="op">=</span> ecr.Repository.from_repository_name(<span class="va">self</span>, <span class="st">&quot;Repo&quot;</span>, <span class="st">&quot;rss-morning&quot;</span>)</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 2. Define the Docker Image Function</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>        docker_func <span class="op">=</span> _lambda.DockerImageFunction(</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>, <span class="st">&quot;RssMorningFunction&quot;</span>,</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>            code<span class="op">=</span>_lambda.DockerImageCode.from_ecr(</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>                repository<span class="op">=</span>repo,</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>                tag_or_digest<span class="op">=</span><span class="st">&quot;latest&quot;</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>            architecture<span class="op">=</span>_lambda.Architecture.ARM_64, <span class="co"># Cheaper/Faster if using ARM</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>            timeout<span class="op">=</span>Duration.minutes(<span class="dv">15</span>), <span class="co"># Max for Lambda</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>            memory_size<span class="op">=</span><span class="dv">1024</span>, <span class="co"># 1GB (Adjust based on needs)</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>            environment<span class="op">=</span>{</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;RSS_MORNING_ENV&quot;</span>: <span class="st">&quot;prod&quot;</span>,</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>                <span class="co"># &quot;OPENAI_API_KEY&quot;: &quot;...&quot; # BETTER: Use Secrets!</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 3. Grant Permissions to Read Secrets</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Assuming secret exists with name &quot;rss-morning/openai-key&quot;</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># secret = secretsmanager.Secret.from_secret_name_v2(self, &quot;OpenAIKey&quot;, &quot;rss-morning/openai-key&quot;)</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># secret.grant_read(docker_func)</span></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 4. Schedule (EventBridge)</span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Run every day at 7:00 AM UTC</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>        rule <span class="op">=</span> events.Rule(</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>, <span class="st">&quot;DailyRunRule&quot;</span>,</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>            schedule<span class="op">=</span>events.Schedule.cron(minute<span class="op">=</span><span class="st">&quot;0&quot;</span>, hour<span class="op">=</span><span class="st">&quot;7&quot;</span>)</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>        rule.add_target(targets.LambdaFunction(docker_func))</span></code></pre></div>
<h2 id="deploy">3. Deploy</h2>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">cdk</span> deploy</span></code></pre></div>
<h1 id="part-6-pipeline-deployment">Part 6: Pipeline &amp;
Deployment</h1>
<p>We are ready to build the artifact and define the running task.</p>
<h2 id="build-and-push">1. Build and Push</h2>
<p><strong>Authentication</strong>: Login Docker to AWS ECR.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="va">ACCOUNT_ID</span><span class="op">=</span><span class="va">$(</span><span class="ex">aws</span> sts get-caller-identity <span class="at">--query</span> Account <span class="at">--output</span> text<span class="va">)</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="va">REGION</span><span class="op">=</span><span class="va">$(</span><span class="ex">aws</span> configure get region<span class="va">)</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="va">ECR_URL</span><span class="op">=</span><span class="st">&quot;</span><span class="va">${ACCOUNT_ID}</span><span class="st">.dkr.ecr.</span><span class="va">${REGION}</span><span class="st">.amazonaws.com&quot;</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ecr get-login-password <span class="at">--region</span> <span class="va">$REGION</span> <span class="kw">|</span> <span class="ex">docker</span> login <span class="at">--username</span> AWS <span class="at">--password-stdin</span> <span class="va">$ECR_URL</span></span></code></pre></div>
<p><strong>Build &amp; Push</strong>:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> build <span class="at">-t</span> rss-morning .</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> tag rss-morning:latest <span class="va">$ECR_URL</span>/rss-morning:latest</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> push <span class="va">$ECR_URL</span>/rss-morning:latest</span></code></pre></div>
<h2 id="register-task-definition">2. Register Task Definition</h2>
<p><strong>Why?</strong> This tells ECS <em>how</em> to run the
container (how much CPU, which image, which secrets).</p>
<p><strong>Action</strong>: Create <code>task-def.json</code>.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;family&quot;</span><span class="fu">:</span> <span class="st">&quot;rss-morning&quot;</span><span class="fu">,</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;networkMode&quot;</span><span class="fu">:</span> <span class="st">&quot;awsvpc&quot;</span><span class="fu">,</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;requiresCompatibilities&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;FARGATE&quot;</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;cpu&quot;</span><span class="fu">:</span> <span class="st">&quot;256&quot;</span><span class="fu">,</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;memory&quot;</span><span class="fu">:</span> <span class="st">&quot;512&quot;</span><span class="fu">,</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;executionRoleArn&quot;</span><span class="fu">:</span> <span class="st">&quot;arn:aws:iam::ACCOUNT_ID:role/RssMorningExecutionRole&quot;</span><span class="fu">,</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;taskRoleArn&quot;</span><span class="fu">:</span> <span class="st">&quot;arn:aws:iam::ACCOUNT_ID:role/RssMorningTaskRole&quot;</span><span class="fu">,</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;containerDefinitions&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;app&quot;</span><span class="fu">,</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;image&quot;</span><span class="fu">:</span> <span class="st">&quot;ACCOUNT_ID.dkr.ecr.REGION.amazonaws.com/rss-morning:latest&quot;</span><span class="fu">,</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;essential&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;environment&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;RSS_MORNING_LOG_STDOUT&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="st">&quot;1&quot;</span> <span class="fu">}</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;secrets&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;OPENAI_API_KEY&quot;</span><span class="fu">,</span> <span class="dt">&quot;valueFrom&quot;</span><span class="fu">:</span> <span class="st">&quot;/rss-morning/OPENAI_API_KEY&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;RESEND_API_KEY&quot;</span><span class="fu">,</span> <span class="dt">&quot;valueFrom&quot;</span><span class="fu">:</span> <span class="st">&quot;/rss-morning/RESEND_API_KEY&quot;</span> <span class="fu">}</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;logConfiguration&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;logDriver&quot;</span><span class="fu">:</span> <span class="st">&quot;awslogs&quot;</span><span class="fu">,</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;options&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;awslogs-group&quot;</span><span class="fu">:</span> <span class="st">&quot;/ecs/rss-morning&quot;</span><span class="fu">,</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;awslogs-region&quot;</span><span class="fu">:</span> <span class="st">&quot;REGION&quot;</span><span class="fu">,</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;awslogs-stream-prefix&quot;</span><span class="fu">:</span> <span class="st">&quot;ecs&quot;</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><em>Replace <code>ACCOUNT_ID</code> and <code>REGION</code> in the
file above.</em></p>
<p><strong>Register</strong>:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ecs register-task-definition <span class="at">--cli-input-json</span> file://task-def.json</span></code></pre></div>
<h1 id="part-7-scheduling">Part 7: Scheduling</h1>
<h2 id="overview">Overview</h2>
<p>We use <strong>Amazon EventBridge</strong> to trigger the Lambda
function on a defined schedule.</p>
<h2 id="cron-syntax">Cron Syntax</h2>
<p>The schedule uses standard cron syntax:
<code>cron(Minutes Hours Day-of-month Month Day-of-week Year)</code> *
Note: AWS Cron fields are slightly different from standard Linux
cron.</p>
<p><strong>Example</strong>: Run at 07:00 AM UTC every day.
<code>cron(0 7 * * ? *)</code></p>
<h2 id="cdk-implementation">CDK Implementation</h2>
<p>As shown in <code>05_infrastructure.md</code>, the
<code>aws-events</code> module makes this simple:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>rule <span class="op">=</span> events.Rule(</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>, <span class="st">&quot;DailyRunRule&quot;</span>,</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    schedule<span class="op">=</span>events.Schedule.cron(minute<span class="op">=</span><span class="st">&quot;0&quot;</span>, hour<span class="op">=</span><span class="st">&quot;7&quot;</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>rule.add_target(targets.LambdaFunction(docker_func))</span></code></pre></div>
<h2 id="manual-setup-console">Manual Setup (Console)</h2>
<ol type="1">
<li>Go to <strong>Amazon EventBridge</strong> &gt;
<strong>Rules</strong>.</li>
<li>Click <strong>Create rule</strong>.</li>
<li><strong>Name</strong>: <code>rss-morning-daily</code>.</li>
<li><strong>Schedule type</strong>: <strong>Schedule</strong> -&gt;
<strong>A fine-grained schedule (Cron)</strong>.</li>
<li><strong>Cron expression</strong>: <code>0 7 * * ? *</code>.</li>
<li><strong>Target 1</strong>: <strong>AWS Lambda
function</strong>.</li>
<li>Select your <code>rss-morning</code> function.</li>
<li>Create.</li>
</ol>
</body>
</html>
